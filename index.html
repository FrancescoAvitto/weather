<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weather Js App</title>


    <!-- css bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <style>
                *, *::after, *::before {
        box-sizing:border-box;
        }

        body {
        margin:0;
        background-color: hsl(80,100%, 85%);
        color:hsl(80, 100%, 10%);
        font-family: sans-serif;
        }

        .blurred {
        filter:blur(3px);
        overflow:hidden;
        }

        .header {
        display:flex;
        align-items:center;

        }

        .header-left {
        display: flex;
        width:50%;
        align-items: center;
        justify-content: center;
        margin:.5rem;
        padding: .5rem;
        border-right:2px solid hsl(80,100%,10%);

        }

        .weather-icon {
        width:40px;
        height:40px;
        object-fit:contain;

        }

        .weather-icon.large {
        width:80px;
        height:80px;
        }

        .header-current-temp {
        font-size:2rem;
        margin-left:1rem;
        }

        .header-right {
        display:grid;
        width:50%;
        justify-content: space-around;
        gap:0.5rem;
        grid-template-columns: repeat(3,auto);
        grid-template-rows:repeat(2,auto);
        }

        .info-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        }

        .label {
        text-transform: uppercase;
        font-weight:bold;
        font-size:0.6rem;
        color:hsl(80,100%, 20%);


        }

        .value-sub-info {
        font-weight:lighter;
        font-size:0.75rem;
        }

        .day-section {
        display:grid;
        grid-template-columns: repeat(auto-fit, 70px);
        gap:.5rem;
        justify-content: center;
        padding:1rem;
        }

        .day-card {
        display:flex;
        flex-direction:column;
        align-items:center;
        border:none;
        border-radius:0.25rem;
        padding:0.25rem;
        }

        .day-card-day {
        font-size:.75rem;
        color:hsl(80,100%, 20%);
        margin-top:0.5rem;

        }

        .hour-section {
        width:100%;
        text-align:center;
        border-spacing:0;
        }

        .hour-row {
        background-color: hsl(80, 60%, 75%);
        }

        .hour-row:nth-child(2n) {
        background-color: hsl(80, 60%, 70%);
        }

        .hour-row > td {
        padding:0.25rem 0.5rem;
        }





    </style>
  </head>
  <body class="blurred">

    <div class="container">

      <div class="row d-block d-md-none pt-3 pb-2 justify-content-center text-center">
       <span class="h2 fw-bold mb-0">Meteo:</span>  <span class="city h2 fw-bold mb-0" style="font-weight:700"></span>
       <p id="today" class="h3 fw-bold mb-0"></p>
      </div>
      

        <div class="row justify-content-center">
            <div class="col-12 col-md-10">
                <header class="header shadow my-3">
                  <div class="header-left">
                    <span class="h2 city fw-bold mx-3 mb-0 d-none d-md-block" style="font-weight:700"></span>
                    <img src="icons/sun.svg" data-current-icon class="weather-icon large">
                    <div class="header-current-temp">
                      <span data-current-temp>31</span>&deg;
            
                    </div>
            
                  </div>
                  <div class="header-right">
                    <div class="info-group">
                      <div class="label">Max</div>
                      <div><span data-current-high>32</span>&deg;</div>
                    </div>
            
                    <div class="info-group">
                      <div class="label">Max percepita</div>
                      <div><span data-current-fl-high>27</span>&deg;</div>
                    </div>
            
                    <div class="info-group">
                      <div class="label">Vento</div>
                      <div><span data-current-wind>9</span><span class="value-sub-info">km/h</span></div>
                    </div>
            
                    <div class="info-group">
                      <div class="label">Min</div>
                      <div><span data-current-low>19</span>&deg;</div>
                    </div>
            
                    <div class="info-group">
                      <div class="label">Min percepita</div>
                      <div><span data-current-fl-low>12</span>&deg;</div>
                    </div>
            
                    <div class="info-group">
                      <div class="label">Precip</div>
                      <div><span data-current-precip>0.1</span><span class="value-sub-info">mm</span></div>
                    </div>
            
                  </div>
                </header>
            
                <section class="day-section my-3" data-day-section>
            
                  <div class="day-card">
                    <img src="icons/sun.svg" class="weather-icon">
                    <div class="day-card-day">Monday</div>
                    <div class="">32&deg;</div>
                  </div>
            
                  <div class="day-card">
                    <img src="icons/smog.svg" class="weather-icon">
                    <div class="day-card-day">Tuesday</div>
                    <div class="">32&deg;</div>
                  </div>
            
                  <div class="day-card">
                    <img src="icons/cloud.svg" class="weather-icon">
                    <div class="day-card-day">Wednesday</div>
                    <div class="">32&deg;</div>
                  </div>
            
                  <div class="day-card">
                    <img src="icons/cloud-sun.svg" class="weather-icon">
                    <div class="day-card-day">Thursday</div>
                    <div class="">32&deg;</div>
                  </div>
            
                  <div class="day-card">
                    <img src="icons/cloud-bolt.svg" class="weather-icon">
                    <div class="day-card-day">Friday</div>
                    <div class="">32&deg;</div>
                  </div>
            
                  <div class="day-card">
                    <img src="icons/cloud.svg" class="weather-icon">
                    <div class="day-card-day">Saturday</div>
                    <div class="">32&deg;</div>
                  </div>
            
                  <div class="day-card">
                    <img src="icons/sun.svg" class="weather-icon">
                    <div class="day-card-day">Sunday</div>
                    <div class="">32&deg;</div>
                  </div>
            
            
                </section>
            
                <table class="hour-section my-3">
                  <tbody class="shadow" data-hour-section>
                    <tr class="hour-row">
                      <td>
                        <div class="info-group">
                          <div class="label">Thursday</div>
                          <div >3 PM</div>
                        </div>
                      </td>
                      <td>
                        <img src="icons/sun.svg" class="weather-icon">
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">Temp</div>
                          <div >31&deg;</div>
                        </div>
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">FL Temp</div>
                          <div >25&deg;</div>
                        </div>
            
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">Wind</div>
                          <div >26<span class="value-sub-info">mph</span></div>
                        </div>
            
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">Precip</div>
                          <div >0<span class="value-sub-info">inch</span></div>
                        </div>
            
                      </td>
            
                    </tr>
                    <tr class="hour-row">
                      <td>
                        <div class="info-group">
                          <div class="label">Friday</div>
                          <div >3 PM</div>
                        </div>
                      </td>
                      <td>
                        <img src="icons/cloud.svg" class="weather-icon">
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">Temp</div>
                          <div >31&deg;</div>
                        </div>
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">FL Temp</div>
                          <div >25&deg;</div>
                        </div>
            
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">Wind</div>
                          <div >26<span class="value-sub-info">mph</span></div>
                        </div>
            
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">Precip</div>
                          <div >0<span class="value-sub-info">inch</span></div>
                        </div>
            
                      </td>
            
                    </tr>
                    <tr class="hour-row">
                      <td>
                        <div class="info-group">
                          <div class="label">Saturday</div>
                          <div >3 PM</div>
                        </div>
                      </td>
                      <td>
                        <img src="icons/sun.svg" class="weather-icon">
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">Temp</div>
                          <div >31&deg;</div>
                        </div>
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">FL Temp</div>
                          <div >25&deg;</div>
                        </div>
            
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">Wind</div>
                          <div >26<span class="value-sub-info">mph</span></div>
                        </div>
            
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">Precip</div>
                          <div >0<span class="value-sub-info">inch</span></div>
                        </div>
            
                      </td>
            
                    </tr>
                    <tr class="hour-row">
                      <td>
                        <div class="info-group">
                          <div class="label">Sunday</div>
                          <div >3 PM</div>
                        </div>
                      </td>
                      <td>
                        <img src="icons/cloud-showers-heavy.svg" class="weather-icon">
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">Temp</div>
                          <div >31&deg;</div>
                        </div>
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">FL Temp</div>
                          <div >25&deg;</div>
                        </div>
            
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">Wind</div>
                          <div >26<span class="value-sub-info">mph</span></div>
                        </div>
            
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">Precip</div>
                          <div >0<span class="value-sub-info">inch</span></div>
                        </div>
            
                      </td>
            
                    </tr>
                    <tr class="hour-row">
                      <td>
                        <div class="info-group">
                          <div class="label">Monday</div>
                          <div >3 PM</div>
                        </div>
                      </td>
                      <td>
                        <img src="icons/cloud-sun.svg" class="weather-icon">
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">Temp</div>
                          <div >31&deg;</div>
                        </div>
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">FL Temp</div>
                          <div >25&deg;</div>
                        </div>
            
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">Wind</div>
                          <div >26<span class="value-sub-info">mph</span></div>
                        </div>
            
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">Precip</div>
                          <div >0<span class="value-sub-info">inch</span></div>
                        </div>
            
                      </td>
            
                    </tr>
                    <tr class="hour-row">
                      <td>
                        <div class="info-group">
                          <div class="label">Tuesday</div>
                          <div >3 PM</div>
                        </div>
                      </td>
                      <td>
                        <img src="icons/cloud-bolt.svg" class="weather-icon">
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">Temp</div>
                          <div >31&deg;</div>
                        </div>
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">FL Temp</div>
                          <div >25&deg;</div>
                        </div>
            
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">Wind</div>
                          <div >26<span class="value-sub-info">mph</span></div>
                        </div>
            
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">Precip</div>
                          <div >0<span class="value-sub-info">inch</span></div>
                        </div>
            
                      </td>
            
                    </tr>
                    <tr class="hour-row">
                      <td>
                        <div class="info-group">
                          <div class="label">Wednesday</div>
                          <div >3 PM</div>
                        </div>
                      </td>
                      <td>
                        <img src="icons/smog.svg" class="weather-icon">
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">Temp</div>
                          <div >31&deg;</div>
                        </div>
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">FL Temp</div>
                          <div >25&deg;</div>
                        </div>
            
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">Wind</div>
                          <div >26<span class="value-sub-info">mph</span></div>
                        </div>
            
                      </td>
                      <td>
                        <div class="info-group">
                          <div class="label">Precip</div>
                          <div >0<span class="value-sub-info">inch</span></div>
                        </div>
            
                      </td>
            
                    </tr>
            
            
            
                  </tbody>
                </table>

            </div>
        </div>
    </div>




    <template id="day-card-template">
      <div class="day-card shadow my-2 rounded">
        <img data-icon class="weather-icon">
        <div class="day-card-day" data-date ></div>
        <div><span data-temp></span><span>&deg;</span></div>
      </div>
    </template>
    <template id="hour-row-template">
      <tr class="hour-row">
        <td>
          <div class="info-group">
            <div class="label" data-day></div>
            <div data-time ></div>
          </div>
        </td>
        <td>
          <img data-icon class="weather-icon">
        </td>
        <td>
          <div class="info-group">
            <div class="label">Temp</div>
           <div><span data-temp></span><span>&deg;</span></div>
            
          </div>
        </td>
        <td>
          <div class="info-group">
            <div class="label">Percepita</div>
            <div><span data-fl-temp></span><span>&deg;</span></div>
          </div>

        </td>
        <td>
          <div class="info-group">
            <div class="label">Vento</div>
            <div ><span data-wind></span><span class="value-sub-info">km/h</span></div>
          </div>

        </td>
        <td>
          <div class="info-group">
            <div class="label">Precip</div>
            <div ><span data-precip></span><span class="value-sub-info">mm</span></div>
          </div>

        </td>

      </tr>

    </template>

    <!-- cdn bootstrap -->
        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

    <!-- cdn axios  -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.2.2/axios.min.js" integrity="sha512-QTnb9BQkG4fBYIt9JGvYmxPpd6TBeKp6lsUrtiVQsrJ9sb33Bn9s0wMQO9qVBFbPX3xHRAsBHvXlcsrnJjExjg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>



    <script>



        // weatherjs 

        function getWeather(lat, lon, timezone){
        return axios.get("https://api.open-meteo.com/v1/forecast?hourly=temperature_2m,apparent_temperature,precipitation,weathercode,windspeed_10m&daily=weathercode,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,precipitation_sum,windspeed_10m_max&current_weather=true&timeformat=unixtime", {params: {
            latitude: lat,
            longitude: lon,
            timezone
        }}).then(({data}) => {
            return {
                current: parseCurrentWeather(data),
                daily: parseDailyWeather(data),
                hourly: parseHourlyWeather(data)
            }

        })
        }



    //    function getWeather(lat, lon, timezone) {
    //       async  function getData(){
    //           try {
    //               const response = await fetch('https://api.open-meteo.com/v1/forecast?hourly=temperature_2m,apparent_temperature,precipitation,weathercode,windspeed_10m&daily=weathercode,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,precipitation_sum,windspeed_10m_max&current_weather=true&timeformat=unixtime', {params: {
    //               latitude: lat,
    //               longitude: lon,
    //               timezone
    //           }})
    //             console.log(response);
    //               const data = response.json().then(({data}) => {
    //               return {
    //                   current: parseCurrentWeather(data),
    //                   daily: parseDailyWeather(data),
    //                   hourly: parseHourlyWeather(data)
    //               }
      
    //           })
                 
    //           } catch (error) {
    //               console.error(error);
    //           }

    //       }
    //     }



        function parseCurrentWeather({current_weather, daily}){

            const {
                temperature: currentTemp, 
                windspeed: windSpeed,
                weathercode: iconCode 
            } = current_weather;

            const {
                temperature_2m_max: [maxTemp],
                temperature_2m_min: [minTemp],
                apparent_temperature_max: [maxFeelsLike],
                apparent_temperature_min: [minFeelsLike],
                precipitation_sum: [precip],


            } = daily

            return {
                currentTemp: Math.round(currentTemp),
                highTemp: Math.round(maxTemp),
                lowTemp: Math.round(minTemp),
                highFeelsLike: Math.round(maxFeelsLike),
                lowFeelsLike: Math.round(minFeelsLike),
                windSpeed: Math.round(windSpeed),
                precip: Math.round(precip*100) / 100,
                iconCode
            }
        }

        function parseDailyWeather({ daily }){
            return daily.time.map((time, index) => {
                return {
                    timestamp: time * 1000,
                    iconCode: daily.weathercode[index],
                    maxTemp: Math.round(daily.temperature_2m_max[index])
                }
            })

        }

        function parseHourlyWeather({ hourly, current_weather }) {
            return hourly.time
            .map((time, index) => {
                return {
                timestamp: time * 1000,
                iconCode: hourly.weathercode[index],
                temp: Math.round(hourly.temperature_2m[index]),
                feelsLike: Math.round(hourly.apparent_temperature[index]),
                windSpeed: Math.round(hourly.windspeed_10m[index]),
                precip: Math.round(hourly.precipitation[index] * 100) / 100,
                }
            })
            .filter(({ timestamp }) => timestamp >= current_weather.time * 1000)
        }






        // main
        navigator.geolocation.getCurrentPosition(positionSuccess, positionError)


        // get city by latitude and longitude

        
        
        function positionSuccess({ coords}){

    
            const lat = coords.latitude;
            const lon = coords.longitude;
            const key = 'c9a829a9377b4dc98f829abf3532654c';
            const url = `https://api.opencagedata.com/geocode/v1/json?q=${lat}%2C${lon}&key=${key}`;
            fetch(url)
              .then((response) => response.json())
              .then((data) => {
                const city = data.results[0].components.city;
                renderCity(city)
                
              });

    



          

        getWeather(coords.latitude, coords.longitude, Intl.DateTimeFormat().resolvedOptions().timeZone)
        .then( renderWeather)
        .catch( e =>{
            console.log(e);
            alert('Error getting Weather')
        })

        }

        



    

        function positionError(){
        alert('There was an error getting your location. Please allow us to use your location and refresh the page.')
        }


        function renderCity(city){
          let cityWrappers = document.querySelectorAll('.city');
          cityWrappers.forEach(el => 
          el.innerText = city
          );
          

        }

        function renderDay(){
          let today = new Date().toLocaleString('it-IT');
          let todayWrapper = document.querySelector('#today');
          todayWrapper.innerText = today
        }

        renderDay()



        function renderWeather({current, daily, hourly}){
        renderCurrentWeather(current)
        renderDailyWeather(daily)
        renderHourlyWeather(hourly)
        document.body.classList.remove('blurred');



        }


        function setValue(selector, value, { parent= document} = {}){
        parent.querySelector(`[data-${selector}]`).textContent = value;
        }


        const currentIcon = document.querySelector("[data-current-icon]")

        function getIconUrl(iconCode){
        return `icons/${ICON_MAP.get(iconCode)}.svg`

        }


        function renderCurrentWeather(current){
        currentIcon.src = getIconUrl(current.iconCode)

        setValue("current-temp", current.currentTemp)
        setValue("current-high", current.highTemp)
        setValue("current-low", current.lowTemp)
        setValue("current-fl-high", current.highFeelsLike)
        setValue("current-fl-low", current.lowFeelsLike)
        setValue("current-wind", current.windSpeed)
        setValue("current-precip", current.precip)


        }

        const DAY_FORMATTER = new Intl.DateTimeFormat(undefined, { weekday: "long" })
        const dailySection = document.querySelector("[data-day-section]")
        const dayCardTemplate = document.getElementById("day-card-template")
        function renderDailyWeather(daily) {
        dailySection.innerHTML = ""
        daily.forEach(day => {
            const element = dayCardTemplate.content.cloneNode(true)
            setValue("temp", day.maxTemp, { parent: element })
            setValue("date", DAY_FORMATTER.format(day.timestamp), { parent: element })
            element.querySelector("[data-icon]").src = getIconUrl(day.iconCode)
            dailySection.append(element)
        })
        }



        const HOUR_FORMATTER = new Intl.DateTimeFormat(undefined, { hour: "numeric" })
        const hourlySection = document.querySelector("[data-hour-section]")
        const hourRowTemplate = document.getElementById("hour-row-template")
        function renderHourlyWeather(hourly) {
        hourlySection.innerHTML = ""
        hourly.forEach(hour => {
            const element = hourRowTemplate.content.cloneNode(true)
            setValue("temp", hour.temp, { parent: element })
            setValue("fl-temp", hour.feelsLike, { parent: element })
            setValue("wind", hour.windSpeed, { parent: element })
            setValue("precip", hour.precip, { parent: element })
            setValue("day", DAY_FORMATTER.format(hour.timestamp), { parent: element })
            setValue("time",`${HOUR_FORMATTER.format(hour.timestamp)}:00` , { parent: element })
            element.querySelector("[data-icon]").src = getIconUrl(hour.iconCode)
            hourlySection.append(element)
        })
        }


        
                // iconMap 

         const ICON_MAP = new Map()
        addMapping([0,1], 'sun');
        addMapping([2], 'cloud-sun');
        addMapping([3], 'cloud');
        addMapping([45,48], 'smog');
        addMapping([51,53,55,56,57,61,63,65,66,67,80,81,82], 'cloud-showers-heavy');
        addMapping([71,73,75,77,85,86], 'snowflake');
        addMapping([95,96,99], 'cloud-bolt');





        function addMapping(values, icon) {
            values.forEach(value => {
                ICON_MAP.set(value,icon)
            })
        }

    </script>

  </body>
</html>
